name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate deploy secrets
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "Missing GitHub Secret: VPS_HOST" >&2
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "Missing GitHub Secret: VPS_USER" >&2
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "Missing GitHub Secret: VPS_SSH_KEY" >&2
            exit 1
          fi

          echo "Secrets look set. Continuing."

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DIR: ${{ secrets.VPS_APP_DIR }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22667 }}
          envs: APP_DIR
          script: |
            set -euo pipefail

            APP_DIR="${APP_DIR:-/home/bitasi/apps/bitasi}"

            echo "==> Go to app directory: ${APP_DIR}"
            cd "$APP_DIR"

            if [ ! -d .git ]; then
              echo "ERROR: $APP_DIR is not a git repo" >&2
              pwd
              ls -la
              exit 1
            fi

            echo "==> Update code"
            git fetch origin main
            git reset --hard origin/main

            echo "==> Ensure .env exists (VPS-local config)"
            if [ ! -f .env ]; then
              if [ -f .env.example ]; then
                cp .env.example .env
                chmod 600 .env || true
                echo "Created .env from .env.example. Edit .env on the VPS to set SMTP/admin secrets."
              else
                # Keep docker-compose from failing on missing env_file
                touch .env
                chmod 600 .env || true
                echo "Created empty .env. Edit .env on the VPS to set SMTP/admin secrets."
              fi
            fi

            echo "==> Pick compose command"
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif docker-compose --version >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "ERROR: Neither 'docker compose' nor 'docker-compose' is available on the VPS." >&2
              echo "Install docker compose plugin or docker-compose binary." >&2
              exit 1
            fi

            echo "==> Pick compose file"
            COMPOSE_FILE="docker-compose.yml"
            if [ -f docker-compose.postgres.yml ]; then
              COMPOSE_FILE="docker-compose.postgres.yml"
            fi
            echo "Using compose file: ${COMPOSE_FILE}"

            echo "==> Cleanup old containers (safe best-effort)"
            # When switching between compose files, old services (e.g. bita-mock-backend)
            # can keep the project network busy and break `down`.
            $COMPOSE -f docker-compose.yml down --remove-orphans >/dev/null 2>&1 || true
            $COMPOSE -f docker-compose.postgres.yml down --remove-orphans >/dev/null 2>&1 || true

            # Force-remove any leftover containers from older stacks (names are prefixed by compose project).
            docker rm -f $(docker ps -aq --filter "name=bita-mock-backend") >/dev/null 2>&1 || true
            docker rm -f $(docker ps -aq --filter "name=bita-backend") >/dev/null 2>&1 || true
            docker rm -f $(docker ps -aq --filter "name=_db_") >/dev/null 2>&1 || true

            echo "==> Restart containers ($COMPOSE)"
            $COMPOSE -f "$COMPOSE_FILE" down --remove-orphans || true
            $COMPOSE -f "$COMPOSE_FILE" up -d --build --remove-orphans

            echo "==> Containers"
            $COMPOSE -f "$COMPOSE_FILE" ps || true

            echo "==> Health check (retry up to ~30s)"
            ok=0
            for i in $(seq 1 15); do
              if curl -fsS http://127.0.0.1:8080/health >/dev/null; then
                ok=1
                break
              fi
              echo "health not ready yet (${i}/15)" >&2
              sleep 2
            done

            if [ "$ok" != "1" ]; then
              echo "ERROR: health check failed" >&2
              echo "==> Recent logs (tail 200)" >&2
              $COMPOSE -f "$COMPOSE_FILE" logs --tail=200 || true
              exit 1
            fi

            curl -fsS http://127.0.0.1:8080/health | head -c 200 || true

            echo "==> Done"
