name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate deploy secrets
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "Missing GitHub Secret: VPS_HOST" >&2
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "Missing GitHub Secret: VPS_USER" >&2
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "Missing GitHub Secret: VPS_SSH_KEY" >&2
            exit 1
          fi

          echo "Secrets look set. Continuing."

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DIR: ${{ secrets.VPS_APP_DIR }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22667 }}
          envs: APP_DIR
          script: |
            set -euo pipefail

            APP_DIR="${APP_DIR:-/home/bitasi/apps/bitasi}"

            echo "==> Go to app directory: ${APP_DIR}"
            cd "$APP_DIR"

            if [ ! -d .git ]; then
              echo "ERROR: $APP_DIR is not a git repo" >&2
              pwd
              ls -la
              exit 1
            fi

            echo "==> Update code"
            git fetch origin main
            git reset --hard origin/main

            echo "==> Pick compose command"
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif docker-compose --version >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "ERROR: Neither 'docker compose' nor 'docker-compose' is available on the VPS." >&2
              echo "Install docker compose plugin or docker-compose binary." >&2
              exit 1
            fi

            echo "==> Restart containers ($COMPOSE)"
            $COMPOSE down
            $COMPOSE up -d --build --remove-orphans

            echo "==> Containers"
            $COMPOSE ps || true

            echo "==> Health check (retry up to ~30s)"
            ok=0
            for i in $(seq 1 15); do
              if curl -fsS http://127.0.0.1:8080/health >/dev/null; then
                ok=1
                break
              fi
              echo "health not ready yet (${i}/15)" >&2
              sleep 2
            done

            if [ "$ok" != "1" ]; then
              echo "ERROR: health check failed" >&2
              echo "==> Recent logs (tail 200)" >&2
              $COMPOSE logs --tail=200 || true
              exit 1
            fi

            curl -fsS http://127.0.0.1:8080/health | head -c 200 || true

            echo "==> Done"
